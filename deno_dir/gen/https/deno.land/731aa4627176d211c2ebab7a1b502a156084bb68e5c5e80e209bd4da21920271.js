import { denoDelay } from "../deps.ts";
import { asyncDecorator } from "../misc.ts";
import { defaultDuration } from "./options.ts";
import { TimeoutError } from "./timeoutError.ts";
export async function waitUntilAsync(fn, duration = defaultDuration, error = new TimeoutError("function did not complete within allowed time")) {
    const canary = Symbol("RETRY_LIB_FN_EXPIRED");
    const result = await Promise.race([
        fn(),
        denoDelay(duration).then(() => canary),
    ]);
    if (result === canary) {
        throw error;
    }
    return result;
}
export async function waitUntil(fn, duration, error) {
    const fnAsync = asyncDecorator(fn);
    return await waitUntilAsync(fnAsync, duration, error);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2FpdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndhaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN2QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBU2pELE1BQU0sQ0FBQyxLQUFLLFVBQVUsY0FBYyxDQUNsQyxFQUE4QixFQUM5QixXQUFtQixlQUFlLEVBQ2xDLFFBQWUsSUFBSSxZQUFZLENBQzdCLCtDQUErQyxDQUNoRDtJQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQztRQUNoQyxFQUFFLEVBQUU7UUFDSixTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQztLQUN2QyxDQUFDLENBQUM7SUFDSCxJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7UUFDckIsTUFBTSxLQUFLLENBQUM7S0FDYjtJQUNELE9BQU8sTUFBcUIsQ0FBQztBQUMvQixDQUFDO0FBU0QsTUFBTSxDQUFDLEtBQUssVUFBVSxTQUFTLENBQzdCLEVBQVcsRUFDWCxRQUFpQixFQUNqQixLQUFhO0lBRWIsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLE9BQU8sTUFBTSxjQUFjLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUN4RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IHNpbmNlIDIwMjAsIEZyYW5ja0xkeC4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5pbXBvcnQgeyBkZW5vRGVsYXkgfSBmcm9tIFwiLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgYXN5bmNEZWNvcmF0b3IgfSBmcm9tIFwiLi4vbWlzYy50c1wiO1xuaW1wb3J0IHsgZGVmYXVsdER1cmF0aW9uIH0gZnJvbSBcIi4vb3B0aW9ucy50c1wiO1xuaW1wb3J0IHsgVGltZW91dEVycm9yIH0gZnJvbSBcIi4vdGltZW91dEVycm9yLnRzXCI7XG5cbi8qKiBcbiAqIHdhaXQgZm9yIGEgZnVuY3Rpb24gdG8gY29tcGxldGUgd2l0aGluIGEgZ2l2bmUgZHVyYXRpb24gb3IgdGhyb3cgYW4gZXhjZXB0aW9uLlxuICogIFxuICogQHBhcmFtIGZuIHRoZSBhc3luYyBmdW5jdGlvbiB0byBleGVjdXRlXG4gKiBAcGFyYW0gZHVyYXRpb24gdGltZW91dCBpbiBtaWxsaXNlY29uZHNcbiAqIEBwYXJhbSBbZXJyb3JdIGN1c3RvbSBlcnJvciB0byB0aHJvdyB3aGVuIGZuIGR1cmF0aW9uIGV4Y2VlZGVkIGR1cmF0aW9uLiBJZiBub3QgcHJvdmlkZWQgYSBUaW1lb3V0RXJyb3IgaXMgdGhyb3duLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2FpdFVudGlsQXN5bmM8UkVUVVJOX1RZUEU+KFxuICBmbjogKCkgPT4gUHJvbWlzZTxSRVRVUk5fVFlQRT4sXG4gIGR1cmF0aW9uOiBudW1iZXIgPSBkZWZhdWx0RHVyYXRpb24sXG4gIGVycm9yOiBFcnJvciA9IG5ldyBUaW1lb3V0RXJyb3IoXG4gICAgXCJmdW5jdGlvbiBkaWQgbm90IGNvbXBsZXRlIHdpdGhpbiBhbGxvd2VkIHRpbWVcIixcbiAgKSxcbik6IFByb21pc2U8UkVUVVJOX1RZUEU+IHtcbiAgY29uc3QgY2FuYXJ5ID0gU3ltYm9sKFwiUkVUUllfTElCX0ZOX0VYUElSRURcIik7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgZm4oKSxcbiAgICBkZW5vRGVsYXkoZHVyYXRpb24pLnRoZW4oKCkgPT4gY2FuYXJ5KSxcbiAgXSk7XG4gIGlmIChyZXN1bHQgPT09IGNhbmFyeSkge1xuICAgIHRocm93IGVycm9yO1xuICB9XG4gIHJldHVybiByZXN1bHQgYXMgUkVUVVJOX1RZUEU7XG59XG5cbi8qKiBcbiAqIHdhaXQgZm9yIGEgZnVuY3Rpb24gdG8gY29tcGxldGUgd2l0aGluIGEgZ2l2bmUgZHVyYXRpb24gb3IgdGhyb3cgYW4gZXhjZXB0aW9uLlxuICogIFxuICogQHBhcmFtIGZuIHRoZSBmdW5jdGlvbiB0byBleGVjdXRlXG4gKiBAcGFyYW0gZHVyYXRpb24gdGltZW91dCBpbiBtaWxsaXNlY29uZHNcbiAqIEBwYXJhbSBbZXJyb3JdIGN1c3RvbSBlcnJvciB0byB0aHJvdyB3aGVuIGZuIGR1cmF0aW9uIGV4Y2VlZGVkIGR1cmF0aW9uLiBJZiBub3QgcHJvdmlkZWQgYSBUaW1lb3V0RXJyb3IgaXMgdGhyb3duLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2FpdFVudGlsPFQ+KFxuICBmbjogKCkgPT4gVCxcbiAgZHVyYXRpb24/OiBudW1iZXIsXG4gIGVycm9yPzogRXJyb3IsXG4pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgZm5Bc3luYyA9IGFzeW5jRGVjb3JhdG9yKGZuKTtcbiAgcmV0dXJuIGF3YWl0IHdhaXRVbnRpbEFzeW5jKGZuQXN5bmMsIGR1cmF0aW9uLCBlcnJvcik7XG59XG4iXX0=