import { Buffer } from "../buffer.ts";
import { createHash } from "./hash.ts";
import { MAX_ALLOC } from "./constants.ts";
const createHasher = (algorithm) => (value) => Buffer.from(createHash(algorithm).update(value).digest());
function getZeroes(zeros) {
    return Buffer.alloc(zeros);
}
const sizes = {
    md5: 16,
    sha1: 20,
    sha224: 28,
    sha256: 32,
    sha384: 48,
    sha512: 64,
    rmd160: 20,
    ripemd160: 20,
};
function toBuffer(bufferable) {
    if (bufferable instanceof Uint8Array || typeof bufferable === "string") {
        return Buffer.from(bufferable);
    }
    else {
        return Buffer.from(bufferable.buffer);
    }
}
class Hmac {
    hash;
    ipad1;
    opad;
    alg;
    blocksize;
    size;
    ipad2;
    constructor(alg, key, saltLen) {
        this.hash = createHasher(alg);
        const blocksize = (alg === "sha512" || alg === "sha384") ? 128 : 64;
        if (key.length > blocksize) {
            key = this.hash(key);
        }
        else if (key.length < blocksize) {
            key = Buffer.concat([key, getZeroes(blocksize - key.length)], blocksize);
        }
        const ipad = Buffer.allocUnsafe(blocksize + sizes[alg]);
        const opad = Buffer.allocUnsafe(blocksize + sizes[alg]);
        for (let i = 0; i < blocksize; i++) {
            ipad[i] = key[i] ^ 0x36;
            opad[i] = key[i] ^ 0x5C;
        }
        const ipad1 = Buffer.allocUnsafe(blocksize + saltLen + 4);
        ipad.copy(ipad1, 0, 0, blocksize);
        this.ipad1 = ipad1;
        this.ipad2 = ipad;
        this.opad = opad;
        this.alg = alg;
        this.blocksize = blocksize;
        this.size = sizes[alg];
    }
    run(data, ipad) {
        data.copy(ipad, this.blocksize);
        const h = this.hash(ipad);
        h.copy(this.opad, this.blocksize);
        return this.hash(this.opad);
    }
}
export function pbkdf2Sync(password, salt, iterations, keylen, digest = "sha1") {
    if (typeof iterations !== "number" || iterations < 0) {
        throw new TypeError("Bad iterations");
    }
    if (typeof keylen !== "number" || keylen < 0 || keylen > MAX_ALLOC) {
        throw new TypeError("Bad key length");
    }
    const bufferedPassword = toBuffer(password);
    const bufferedSalt = toBuffer(salt);
    const hmac = new Hmac(digest, bufferedPassword, bufferedSalt.length);
    const DK = Buffer.allocUnsafe(keylen);
    const block1 = Buffer.allocUnsafe(bufferedSalt.length + 4);
    bufferedSalt.copy(block1, 0, 0, bufferedSalt.length);
    let destPos = 0;
    const hLen = sizes[digest];
    const l = Math.ceil(keylen / hLen);
    for (let i = 1; i <= l; i++) {
        block1.writeUInt32BE(i, bufferedSalt.length);
        const T = hmac.run(block1, hmac.ipad1);
        let U = T;
        for (let j = 1; j < iterations; j++) {
            U = hmac.run(U, hmac.ipad2);
            for (let k = 0; k < hLen; k++)
                T[k] ^= U[k];
        }
        T.copy(DK, destPos);
        destPos += hLen;
    }
    return DK;
}
export function pbkdf2(password, salt, iterations, keylen, digest = "sha1", callback) {
    setTimeout(() => {
        let err = null, res;
        try {
            res = pbkdf2Sync(password, salt, iterations, keylen, digest);
        }
        catch (e) {
            err = e;
        }
        if (err) {
            callback(err instanceof Error ? err : new Error("[non-error thrown]"));
        }
        else {
            callback(null, res);
        }
    }, 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGJrZGYyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGJrZGYyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFzQjNDLE1BQU0sWUFBWSxHQUFHLENBQUMsU0FBaUIsRUFBRSxFQUFFLENBQ3pDLENBQUMsS0FBaUIsRUFBRSxFQUFFLENBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEVBQVksQ0FBQyxDQUFDO0FBRXhFLFNBQVMsU0FBUyxDQUFDLEtBQWE7SUFDOUIsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFFRCxNQUFNLEtBQUssR0FBRztJQUNaLEdBQUcsRUFBRSxFQUFFO0lBQ1AsSUFBSSxFQUFFLEVBQUU7SUFDUixNQUFNLEVBQUUsRUFBRTtJQUNWLE1BQU0sRUFBRSxFQUFFO0lBQ1YsTUFBTSxFQUFFLEVBQUU7SUFDVixNQUFNLEVBQUUsRUFBRTtJQUNWLE1BQU0sRUFBRSxFQUFFO0lBQ1YsU0FBUyxFQUFFLEVBQUU7Q0FDZCxDQUFDO0FBRUYsU0FBUyxRQUFRLENBQUMsVUFBcUI7SUFDckMsSUFBSSxVQUFVLFlBQVksVUFBVSxJQUFJLE9BQU8sVUFBVSxLQUFLLFFBQVEsRUFBRTtRQUN0RSxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBd0IsQ0FBQyxDQUFDO0tBQzlDO1NBQU07UUFDTCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ3ZDO0FBQ0gsQ0FBQztBQUVELE1BQU0sSUFBSTtJQUNSLElBQUksQ0FBZ0M7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WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyIHRoZSBEZW5vIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuaW1wb3J0IHsgQnVmZmVyIH0gZnJvbSBcIi4uL2J1ZmZlci50c1wiO1xuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gXCIuL2hhc2gudHNcIjtcbmltcG9ydCB7IE1BWF9BTExPQyB9IGZyb20gXCIuL2NvbnN0YW50cy50c1wiO1xuaW1wb3J0IHsgSEFTSF9EQVRBIH0gZnJvbSBcIi4vdHlwZXMudHNcIjtcblxuZXhwb3J0IHR5cGUgTm9ybWFsaXplZEFsZ29yaXRobXMgPVxuICB8IFwibWQ1XCJcbiAgfCBcInJpcGVtZDE2MFwiXG4gIHwgXCJzaGExXCJcbiAgfCBcInNoYTIyNFwiXG4gIHwgXCJzaGEyNTZcIlxuICB8IFwic2hhMzg0XCJcbiAgfCBcInNoYTUxMlwiO1xuXG50eXBlIEFsZ29yaXRobXMgPVxuICB8IFwibWQ1XCJcbiAgfCBcInJpcGVtZDE2MFwiXG4gIHwgXCJybWQxNjBcIlxuICB8IFwic2hhMVwiXG4gIHwgXCJzaGEyMjRcIlxuICB8IFwic2hhMjU2XCJcbiAgfCBcInNoYTM4NFwiXG4gIHwgXCJzaGE1MTJcIjtcblxuY29uc3QgY3JlYXRlSGFzaGVyID0gKGFsZ29yaXRobTogc3RyaW5nKSA9PlxuICAodmFsdWU6IFVpbnQ4QXJyYXkpID0+XG4gICAgQnVmZmVyLmZyb20oY3JlYXRlSGFzaChhbGdvcml0aG0pLnVwZGF0ZSh2YWx1ZSkuZGlnZXN0KCkgYXMgQnVmZmVyKTtcblxuZnVuY3Rpb24gZ2V0WmVyb2VzKHplcm9zOiBudW1iZXIpIHtcbiAgcmV0dXJuIEJ1ZmZlci5hbGxvYyh6ZXJvcyk7XG59XG5cbmNvbnN0IHNpemVzID0ge1xuICBtZDU6IDE2LFxuICBzaGExOiAyMCxcbiAgc2hhMjI0OiAyOCxcbiAgc2hhMjU2OiAzMixcbiAgc2hhMzg0OiA0OCxcbiAgc2hhNTEyOiA2NCxcbiAgcm1kMTYwOiAyMCxcbiAgcmlwZW1kMTYwOiAyMCxcbn07XG5cbmZ1bmN0aW9uIHRvQnVmZmVyKGJ1ZmZlcmFibGU6IEhBU0hfREFUQSkge1xuICBpZiAoYnVmZmVyYWJsZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgdHlwZW9mIGJ1ZmZlcmFibGUgPT09IFwic3RyaW5nXCIpIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyYWJsZSBhcyBVaW50OEFycmF5KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyYWJsZS5idWZmZXIpO1xuICB9XG59XG5cbmNsYXNzIEhtYWMge1xuICBoYXNoOiAodmFsdWU6IFVpbnQ4QXJyYXkpID0+IEJ1ZmZlcjtcbiAgaXBhZDE6IEJ1ZmZlcjtcbiAgb3BhZDogQnVmZmVyO1xuICBhbGc6IHN0cmluZztcbiAgYmxvY2tzaXplOiBudW1iZXI7XG4gIHNpemU6IG51bWJlcjtcbiAgaXBhZDI6IEJ1ZmZlcjtcblxuICBjb25zdHJ1Y3RvcihhbGc6IEFsZ29yaXRobXMsIGtleTogQnVmZmVyLCBzYWx0TGVuOiBudW1iZXIpIHtcbiAgICB0aGlzLmhhc2ggPSBjcmVhdGVIYXNoZXIoYWxnKTtcblxuICAgIGNvbnN0IGJsb2Nrc2l6ZSA9IChhbGcgPT09IFwic2hhNTEyXCIgfHwgYWxnID09PSBcInNoYTM4NFwiKSA/IDEyOCA6IDY0O1xuXG4gICAgaWYgKGtleS5sZW5ndGggPiBibG9ja3NpemUpIHtcbiAgICAgIGtleSA9IHRoaXMuaGFzaChrZXkpO1xuICAgIH0gZWxzZSBpZiAoa2V5Lmxlbmd0aCA8IGJsb2Nrc2l6ZSkge1xuICAgICAga2V5ID0gQnVmZmVyLmNvbmNhdChba2V5LCBnZXRaZXJvZXMoYmxvY2tzaXplIC0ga2V5Lmxlbmd0aCldLCBibG9ja3NpemUpO1xuICAgIH1cblxuICAgIGNvbnN0IGlwYWQgPSBCdWZmZXIuYWxsb2NVbnNhZmUoYmxvY2tzaXplICsgc2l6ZXNbYWxnXSk7XG4gICAgY29uc3Qgb3BhZCA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShibG9ja3NpemUgKyBzaXplc1thbGddKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2Nrc2l6ZTsgaSsrKSB7XG4gICAgICBpcGFkW2ldID0ga2V5W2ldIF4gMHgzNjtcbiAgICAgIG9wYWRbaV0gPSBrZXlbaV0gXiAweDVDO1xuICAgIH1cblxuICAgIGNvbnN0IGlwYWQxID0gQnVmZmVyLmFsbG9jVW5zYWZlKGJsb2Nrc2l6ZSArIHNhbHRMZW4gKyA0KTtcbiAgICBpcGFkLmNvcHkoaXBhZDEsIDAsIDAsIGJsb2Nrc2l6ZSk7XG5cbiAgICB0aGlzLmlwYWQxID0gaXBhZDE7XG4gICAgdGhpcy5pcGFkMiA9IGlwYWQ7XG4gICAgdGhpcy5vcGFkID0gb3BhZDtcbiAgICB0aGlzLmFsZyA9IGFsZztcbiAgICB0aGlzLmJsb2Nrc2l6ZSA9IGJsb2Nrc2l6ZTtcbiAgICB0aGlzLnNpemUgPSBzaXplc1thbGddO1xuICB9XG5cbiAgcnVuKGRhdGE6IEJ1ZmZlciwgaXBhZDogQnVmZmVyKSB7XG4gICAgZGF0YS5jb3B5KGlwYWQsIHRoaXMuYmxvY2tzaXplKTtcbiAgICBjb25zdCBoID0gdGhpcy5oYXNoKGlwYWQpO1xuICAgIGguY29weSh0aGlzLm9wYWQsIHRoaXMuYmxvY2tzaXplKTtcbiAgICByZXR1cm4gdGhpcy5oYXNoKHRoaXMub3BhZCk7XG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0gaXRlcmF0aW9ucyBOZWVkcyB0byBiZSBoaWdoZXIgb3IgZXF1YWwgdGhhbiB6ZXJvXG4gKiBAcGFyYW0ga2V5bGVuICBOZWVkcyB0byBiZSBoaWdoZXIgb3IgZXF1YWwgdGhhbiB6ZXJvIGJ1dCBsZXNzIHRoYW4gbWF4IGFsbG9jYXRpb24gc2l6ZSAoMl4zMClcbiAqIEBwYXJhbSBkaWdlc3QgQWxnb3JpdGhtIHRvIGJlIHVzZWQgZm9yIGVuY3J5cHRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBia2RmMlN5bmMoXG4gIHBhc3N3b3JkOiBIQVNIX0RBVEEsXG4gIHNhbHQ6IEhBU0hfREFUQSxcbiAgaXRlcmF0aW9uczogbnVtYmVyLFxuICBrZXlsZW46IG51bWJlcixcbiAgZGlnZXN0OiBBbGdvcml0aG1zID0gXCJzaGExXCIsXG4pOiBCdWZmZXIge1xuICBpZiAodHlwZW9mIGl0ZXJhdGlvbnMgIT09IFwibnVtYmVyXCIgfHwgaXRlcmF0aW9ucyA8IDApIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQmFkIGl0ZXJhdGlvbnNcIik7XG4gIH1cbiAgaWYgKHR5cGVvZiBrZXlsZW4gIT09IFwibnVtYmVyXCIgfHwga2V5bGVuIDwgMCB8fCBrZXlsZW4gPiBNQVhfQUxMT0MpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQmFkIGtleSBsZW5ndGhcIik7XG4gIH1cblxuICBjb25zdCBidWZmZXJlZFBhc3N3b3JkID0gdG9CdWZmZXIocGFzc3dvcmQpO1xuICBjb25zdCBidWZmZXJlZFNhbHQgPSB0b0J1ZmZlcihzYWx0KTtcblxuICBjb25zdCBobWFjID0gbmV3IEhtYWMoZGlnZXN0LCBidWZmZXJlZFBhc3N3b3JkLCBidWZmZXJlZFNhbHQubGVuZ3RoKTtcblxuICBjb25zdCBESyA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShrZXlsZW4pO1xuICBjb25zdCBibG9jazEgPSBCdWZmZXIuYWxsb2NVbnNhZmUoYnVmZmVyZWRTYWx0Lmxlbmd0aCArIDQpO1xuICBidWZmZXJlZFNhbHQuY29weShibG9jazEsIDAsIDAsIGJ1ZmZlcmVkU2FsdC5sZW5ndGgpO1xuXG4gIGxldCBkZXN0UG9zID0gMDtcbiAgY29uc3QgaExlbiA9IHNpemVzW2RpZ2VzdF07XG4gIGNvbnN0IGwgPSBNYXRoLmNlaWwoa2V5bGVuIC8gaExlbik7XG5cbiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gbDsgaSsrKSB7XG4gICAgYmxvY2sxLndyaXRlVUludDMyQkUoaSwgYnVmZmVyZWRTYWx0Lmxlbmd0aCk7XG5cbiAgICBjb25zdCBUID0gaG1hYy5ydW4oYmxvY2sxLCBobWFjLmlwYWQxKTtcbiAgICBsZXQgVSA9IFQ7XG5cbiAgICBmb3IgKGxldCBqID0gMTsgaiA8IGl0ZXJhdGlvbnM7IGorKykge1xuICAgICAgVSA9IGhtYWMucnVuKFUsIGhtYWMuaXBhZDIpO1xuICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBoTGVuOyBrKyspIFRba10gXj0gVVtrXTtcbiAgICB9XG5cbiAgICBULmNvcHkoREssIGRlc3RQb3MpO1xuICAgIGRlc3RQb3MgKz0gaExlbjtcbiAgfVxuXG4gIHJldHVybiBESztcbn1cblxuLyoqXG4gKiBAcGFyYW0gaXRlcmF0aW9ucyBOZWVkcyB0byBiZSBoaWdoZXIgb3IgZXF1YWwgdGhhbiB6ZXJvXG4gKiBAcGFyYW0ga2V5bGVuICBOZWVkcyB0byBiZSBoaWdoZXIgb3IgZXF1YWwgdGhhbiB6ZXJvIGJ1dCBsZXNzIHRoYW4gbWF4IGFsbG9jYXRpb24gc2l6ZSAoMl4zMClcbiAqIEBwYXJhbSBkaWdlc3QgQWxnb3JpdGhtIHRvIGJlIHVzZWQgZm9yIGVuY3J5cHRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBia2RmMihcbiAgcGFzc3dvcmQ6IEhBU0hfREFUQSxcbiAgc2FsdDogSEFTSF9EQVRBLFxuICBpdGVyYXRpb25zOiBudW1iZXIsXG4gIGtleWxlbjogbnVtYmVyLFxuICBkaWdlc3Q6IEFsZ29yaXRobXMgPSBcInNoYTFcIixcbiAgY2FsbGJhY2s6ICgoZXJyOiBFcnJvciB8IG51bGwsIGRlcml2ZWRLZXk/OiBCdWZmZXIpID0+IHZvaWQpLFxuKTogdm9pZCB7XG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIGxldCBlcnIgPSBudWxsLCByZXM7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IHBia2RmMlN5bmMoXG4gICAgICAgIHBhc3N3b3JkLFxuICAgICAgICBzYWx0LFxuICAgICAgICBpdGVyYXRpb25zLFxuICAgICAgICBrZXlsZW4sXG4gICAgICAgIGRpZ2VzdCxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXJyID0gZTtcbiAgICB9XG4gICAgaWYgKGVycikge1xuICAgICAgY2FsbGJhY2soZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoXCJbbm9uLWVycm9yIHRocm93bl1cIikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYWxsYmFjayhudWxsLCByZXMpO1xuICAgIH1cbiAgfSwgMCk7XG59XG4iXX0=