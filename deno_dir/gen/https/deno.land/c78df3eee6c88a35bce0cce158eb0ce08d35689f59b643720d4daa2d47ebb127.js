import { sprintf } from "../../../fmt/printf.ts";
import { inspect } from "./inspect.mjs";
let debugImpls;
let testEnabled;
function initializeDebugEnv(debugEnv) {
    debugImpls = Object.create(null);
    if (debugEnv) {
        debugEnv = debugEnv.replace(/[|\\{}()[\]^$+?.]/g, "\\$&")
            .replaceAll("*", ".*")
            .replaceAll(",", "$|^");
        const debugEnvRegex = new RegExp(`^${debugEnv}$`, "i");
        testEnabled = (str) => debugEnvRegex.exec(str) !== null;
    }
    else {
        testEnabled = () => false;
    }
}
function emitWarningIfNeeded(set) {
    if ("HTTP" === set || "HTTP2" === set) {
        console.warn("Setting the NODE_DEBUG environment variable " +
            "to '" + set.toLowerCase() + "' can expose sensitive " +
            "data (such as passwords, tokens and authentication headers) " +
            "in the resulting log.");
    }
}
const noop = () => { };
function debuglogImpl(enabled, set) {
    if (debugImpls[set] === undefined) {
        if (enabled) {
            emitWarningIfNeeded(set);
            debugImpls[set] = function debug(...args) {
                const msg = args.map((arg) => inspect(arg)).join(" ");
                console.error(sprintf("%s %s: %s", set, String(Deno.pid), msg));
            };
        }
        else {
            debugImpls[set] = noop;
        }
    }
    return debugImpls[set];
}
export function debuglog(set, cb) {
    function init() {
        set = set.toUpperCase();
        enabled = testEnabled(set);
    }
    let debug = (...args) => {
        init();
        debug = debuglogImpl(enabled, set);
        if (typeof cb === "function") {
            cb(debug);
        }
        return debug(...args);
    };
    let enabled;
    let test = () => {
        init();
        test = () => enabled;
        return enabled;
    };
    const logger = (...args) => debug(...args);
    Object.defineProperty(logger, "enabled", {
        get() {
            return test();
        },
        configurable: true,
        enumerable: true,
    });
    return logger;
}
let state = "";
if (Deno.permissions) {
    state = (await Deno.permissions.query({
        name: "env",
        variable: "NODE_DEBUG",
    })).state;
}
if (state === "granted") {
    initializeDebugEnv(Deno.env.get("NODE_DEBUG") ?? "");
}
else {
    initializeDebugEnv("");
}
export default { debuglog };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVidWdsb2cuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkZWJ1Z2xvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUl4QyxJQUFJLFVBQXdELENBQUM7QUFDN0QsSUFBSSxXQUFxQyxDQUFDO0FBRzFDLFNBQVMsa0JBQWtCLENBQUMsUUFBZ0I7SUFDMUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakMsSUFBSSxRQUFRLEVBQUU7UUFFWixRQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLENBQUM7YUFDdEQsVUFBVSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUM7YUFDckIsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxQixNQUFNLGFBQWEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLFFBQVEsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZELFdBQVcsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLENBQUM7S0FDekQ7U0FBTTtRQUNMLFdBQVcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUM7S0FDM0I7QUFDSCxDQUFDO0FBSUQsU0FBUyxtQkFBbUIsQ0FBQyxHQUFXO0lBQ3RDLElBQUksTUFBTSxLQUFLLEdBQUcsSUFBSSxPQUFPLEtBQUssR0FBRyxFQUFFO1FBQ3JDLE9BQU8sQ0FBQyxJQUFJLENBQ1YsOENBQThDO1lBQzVDLE1BQU0sR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLEdBQUcseUJBQXlCO1lBQ3RELDhEQUE4RDtZQUM5RCx1QkFBdUIsQ0FDMUIsQ0FBQztLQUNIO0FBQ0gsQ0FBQztBQUVE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cHlyaWdodCAyMDE4LTIwMjIgdGhlIERlbm8gYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG4vLyBDb3B5cmlnaHQgSm95ZW50IGFuZCBOb2RlIGNvbnRyaWJ1dG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5pbXBvcnQgeyBzcHJpbnRmIH0gZnJvbSBcIi4uLy4uLy4uL2ZtdC9wcmludGYudHNcIjtcbmltcG9ydCB7IGluc3BlY3QgfSBmcm9tIFwiLi9pbnNwZWN0Lm1qc1wiO1xuXG4vLyBgZGVidWdJbXBsc2AgYW5kIGB0ZXN0RW5hYmxlZGAgYXJlIGRlbGliZXJhdGVseSBub3QgaW5pdGlhbGl6ZWQgc28gYW55IGNhbGxcbi8vIHRvIGBkZWJ1Z2xvZygpYCBiZWZvcmUgYGluaXRpYWxpemVEZWJ1Z0VudigpYCBpcyBjYWxsZWQgd2lsbCB0aHJvdy5cbmxldCBkZWJ1Z0ltcGxzOiBSZWNvcmQ8c3RyaW5nLCAoLi4uYXJnczogdW5rbm93bltdKSA9PiB2b2lkPjtcbmxldCB0ZXN0RW5hYmxlZDogKHN0cjogc3RyaW5nKSA9PiBib29sZWFuO1xuXG4vLyBgZGVidWdFbnZgIGlzIGluaXRpYWwgdmFsdWUgb2YgcHJvY2Vzcy5lbnYuTk9ERV9ERUJVR1xuZnVuY3Rpb24gaW5pdGlhbGl6ZURlYnVnRW52KGRlYnVnRW52OiBzdHJpbmcpIHtcbiAgZGVidWdJbXBscyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gIGlmIChkZWJ1Z0Vudikge1xuICAgIC8vIFRoaXMgaXMgcnVuIGJlZm9yZSBhbnkgdXNlciBjb2RlLCBpdCdzIE9LIG5vdCB0byB1c2UgcHJpbW9yZGlhbHMuXG4gICAgZGVidWdFbnYgPSBkZWJ1Z0Vudi5yZXBsYWNlKC9bfFxcXFx7fSgpW1xcXV4kKz8uXS9nLCBcIlxcXFwkJlwiKVxuICAgICAgLnJlcGxhY2VBbGwoXCIqXCIsIFwiLipcIilcbiAgICAgIC5yZXBsYWNlQWxsKFwiLFwiLCBcIiR8XlwiKTtcbiAgICBjb25zdCBkZWJ1Z0VudlJlZ2V4ID0gbmV3IFJlZ0V4cChgXiR7ZGVidWdFbnZ9JGAsIFwiaVwiKTtcbiAgICB0ZXN0RW5hYmxlZCA9IChzdHIpID0+IGRlYnVnRW52UmVnZXguZXhlYyhzdHIpICE9PSBudWxsO1xuICB9IGVsc2Uge1xuICAgIHRlc3RFbmFibGVkID0gKCkgPT4gZmFsc2U7XG4gIH1cbn1cblxuLy8gRW1pdHMgd2FybmluZyB3aGVuIHVzZXIgc2V0c1xuLy8gTk9ERV9ERUJVRz1odHRwIG9yIE5PREVfREVCVUc9aHR0cDIuXG5mdW5jdGlvbiBlbWl0V2FybmluZ0lmTmVlZGVkKHNldDogc3RyaW5nKSB7XG4gIGlmIChcIkhUVFBcIiA9PT0gc2V0IHx8IFwiSFRUUDJcIiA9PT0gc2V0KSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgXCJTZXR0aW5nIHRoZSBOT0RFX0RFQlVHIGVudmlyb25tZW50IHZhcmlhYmxlIFwiICtcbiAgICAgICAgXCJ0byAnXCIgKyBzZXQudG9Mb3dlckNhc2UoKSArIFwiJyBjYW4gZXhwb3NlIHNlbnNpdGl2ZSBcIiArXG4gICAgICAgIFwiZGF0YSAoc3VjaCBhcyBwYXNzd29yZHMsIHRva2VucyBhbmQgYXV0aGVudGljYXRpb24gaGVhZGVycykgXCIgK1xuICAgICAgICBcImluIHRoZSByZXN1bHRpbmcgbG9nLlwiLFxuICAgICk7XG4gIH1cbn1cblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9O1xuXG5mdW5jdGlvbiBkZWJ1Z2xvZ0ltcGwoXG4gIGVuYWJsZWQ6IGJvb2xlYW4sXG4gIHNldDogc3RyaW5nLFxuKTogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdm9pZCB7XG4gIGlmIChkZWJ1Z0ltcGxzW3NldF0gPT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChlbmFibGVkKSB7XG4gICAgICBlbWl0V2FybmluZ0lmTmVlZGVkKHNldCk7XG4gICAgICBkZWJ1Z0ltcGxzW3NldF0gPSBmdW5jdGlvbiBkZWJ1ZyguLi5hcmdzOiB1bmtub3duW10pIHtcbiAgICAgICAgY29uc3QgbXNnID0gYXJncy5tYXAoKGFyZykgPT4gaW5zcGVjdChhcmcpKS5qb2luKFwiIFwiKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihzcHJpbnRmKFwiJXMgJXM6ICVzXCIsIHNldCwgU3RyaW5nKERlbm8ucGlkKSwgbXNnKSk7XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWJ1Z0ltcGxzW3NldF0gPSBub29wO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkZWJ1Z0ltcGxzW3NldF07XG59XG5cbi8vIGRlYnVnbG9nSW1wbCBkZXBlbmRzIG9uIHByb2Nlc3MucGlkIGFuZCBwcm9jZXNzLmVudi5OT0RFX0RFQlVHLFxuLy8gc28gaXQgbmVlZHMgdG8gYmUgY2FsbGVkIGxhemlseSBpbiB0b3Agc2NvcGVzIG9mIGludGVybmFsIG1vZHVsZXNcbi8vIHRoYXQgbWF5IGJlIGxvYWRlZCBiZWZvcmUgdGhlc2UgcnVuIHRpbWUgc3RhdGVzIGFyZSBhbGxvd2VkIHRvXG4vLyBiZSBhY2Nlc3NlZC5cbmV4cG9ydCBmdW5jdGlvbiBkZWJ1Z2xvZyhcbiAgc2V0OiBzdHJpbmcsXG4gIGNiOiAoZGVidWc6ICguLi5hcmdzOiB1bmtub3duW10pID0+IHZvaWQpID0+IHZvaWQsXG4pIHtcbiAgZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBzZXQgPSBzZXQudG9VcHBlckNhc2UoKTtcbiAgICBlbmFibGVkID0gdGVzdEVuYWJsZWQoc2V0KTtcbiAgfVxuXG4gIGxldCBkZWJ1ZyA9ICguLi5hcmdzOiB1bmtub3duW10pOiB2b2lkID0+IHtcbiAgICBpbml0KCk7XG4gICAgLy8gT25seSBpbnZva2VzIGRlYnVnbG9nSW1wbCgpIHdoZW4gdGhlIGRlYnVnIGZ1bmN0aW9uIGlzXG4gICAgLy8gY2FsbGVkIGZvciB0aGUgZmlyc3QgdGltZS5cbiAgICBkZWJ1ZyA9IGRlYnVnbG9nSW1wbChlbmFibGVkLCBzZXQpO1xuXG4gICAgaWYgKHR5cGVvZiBjYiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYihkZWJ1Zyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlYnVnKC4uLmFyZ3MpO1xuICB9O1xuXG4gIGxldCBlbmFibGVkOiBib29sZWFuO1xuICBsZXQgdGVzdCA9ICgpID0+IHtcbiAgICBpbml0KCk7XG4gICAgdGVzdCA9ICgpID0+IGVuYWJsZWQ7XG4gICAgcmV0dXJuIGVuYWJsZWQ7XG4gIH07XG5cbiAgY29uc3QgbG9nZ2VyID0gKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gZGVidWcoLi4uYXJncyk7XG5cbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxvZ2dlciwgXCJlbmFibGVkXCIsIHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gdGVzdCgpO1xuICAgIH0sXG4gICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgIGVudW1lcmFibGU6IHRydWUsXG4gIH0pO1xuXG4gIHJldHVybiBsb2dnZXI7XG59XG5cbmxldCBzdGF0ZSA9IFwiXCI7XG5cbmlmIChEZW5vLnBlcm1pc3Npb25zKSB7XG4gIHN0YXRlID0gKGF3YWl0IERlbm8ucGVybWlzc2lvbnMucXVlcnkoe1xuICAgIG5hbWU6IFwiZW52XCIsXG4gICAgdmFyaWFibGU6IFwiTk9ERV9ERUJVR1wiLFxuICB9KSkuc3RhdGU7XG59XG5cbmlmIChzdGF0ZSA9PT0gXCJncmFudGVkXCIpIHtcbiAgaW5pdGlhbGl6ZURlYnVnRW52KERlbm8uZW52LmdldChcIk5PREVfREVCVUdcIikgPz8gXCJcIik7XG59IGVsc2Uge1xuICBpbml0aWFsaXplRGVidWdFbnYoXCJcIik7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHsgZGVidWdsb2cgfTtcbiJdfQ==